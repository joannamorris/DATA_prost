---
title: "PROST Nref Analysis (JS)"
author: "Joanna Morris"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
fontsize: 10pt
---

\scriptsize



# Setup and load files {.unnumbered}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, 
                      comment = "||")
options(width = 130)
library(ggeffects)
library(lme4)
library(afex)
library(gridExtra)
library(emmeans)
library(effectsize)
library(performance)
library(cowplot)  # for use with `plot_grid(x,x,ncol = x)` function
library(e1071) # for use with `skewness()` function
library(lmerTest)
library(tidyverse)
library(MBESS)
```

## Set parameters

Used when comparing two conditions measured in the same participants (e.g., repeated measures, paired t-test, within-subject contrasts in LMMs).

Formula:

$d_z = \frac{\bar{X}{\text{diff}}}{s{\text{diff}}}$

Or, using the t value and sample size:

$d_z = \frac{t}{\sqrt{n}}$

Where:

-	$\bar{X}_{\text{diff}}$ is the mean of the difference scores

-	$s_{\text{diff}}$ is the standard deviation of the difference scores

-	$n$ is the number of participants

This version assumes the standard deviation of the difference scores already accounts for the within-subject correlation.

```{r theme, echo = FALSE}
#  ggplot parameters
theme_set(theme_classic() +  
            theme(legend.position = "bottom", 
                  axis.text=element_text(size=10),
                  axis.title=element_text(size=9)))

# tibble parameters
options(pillar.sigfig = 3)  # Sets tibbles to print only 3 significant decimal places

# Define a custom color palette
my_palette <- c(  "#1F78B4","#E31A1C", "#33A02C")
my_palette_1 <- c("#A6CEE3",  "#FB9A99")
my_palette_2 <- c( "#1F78B4","#E31A1C" )
my_palette_3 <- c("#A6CEE3","#1F78B4","#FB9A99","#E31A1C")


# Create a function to apply this palette
scale_color_custom <- function() {
  scale_color_manual(values = my_palette)
}

scale_fill_custom <- function() {
  scale_fill_manual(values = my_palette)
}



# Install MBESS if you don't have it
# install.packages("MBESS")
# Function to safely compute Cohen's dz and CI
get_dz_CI <- function(t_value, df_value, n) {
  t_value <- as.numeric(t_value)
  df_value <- as.numeric(df_value)

  if (is.na(t_value) || is.na(df_value)) {
    return(c(dz = NA, CI_lower = NA, CI_upper = NA))
  }

  ci_ncp <- conf.limits.nct(t.value = t_value, df = df_value, conf.level = 0.95)
  dz      <- t_value / sqrt(n)
  dz_LCL  <- ci_ncp$Lower.Limit / sqrt(n)
  dz_UCL  <- ci_ncp$Upper.Limit / sqrt(n)
  return(c(dz = dz, CI_lower = dz_LCL, CI_upper = dz_UCL))
}
```

# Load and format data files

```{r, results='hide'}
nref <- read_csv('prost_mea_300500_202508.csv')
subjlist <- read_csv('prost_subjlist_20250812.csv')
subjlist <- as.list(subjlist$x)

centroparietal_channels  <- c('C3','Cz', 'C4', 'CP3', 'CPz', 'CP4', 'P3',  'Pz',  'P4')
posterior_channels <- c('PZ','P4', 'CP4',  'P3',  'CP3', 'CPZ')
frontal_channels <- c('FZ', 'F4', 'F8', 'FT8', 'FC4', 'FT7', 'F7', 'F3',  'FC3', 'FCZ')

nref_labels <- nref |>  filter(ERPset %in% subjlist) |>  filter(ERPset %in% subjlist) |>
  filter(chlabel %in% frontal_channels) |>
  mutate(SubjID = str_extract(ERPset, "\\d{3}")) |>
  mutate(Referentiality = case_when(grepl("Bound variable", binlabel) ~ "Bound variable",  
                                            grepl("Referential", binlabel) ~ "Referential")) |>
  mutate(Gender_Status = case_when(grepl("NonGendered" ,binlabel) ~ "NonGendered",  
                                   grepl("Gendered", binlabel) ~ "Gendered")) |>
  mutate(Pronoun = case_when(grepl("Gender-congruent", binlabel) ~ "Congruent", 
                              grepl("Gender-incongruent", binlabel) ~ "Incongruent",
                              grepl("Gender-neutral", binlabel) ~ "Neutral",
                              grepl("Masculine", binlabel) ~ "Masculine",
                              grepl("Feminine", binlabel) ~ "Feminine")) |>
  mutate(Group = case_when(grepl("S4", ERPset) ~ "NonBinary", 
                           grepl("S3", ERPset) ~ "NonBinary", 
                           grepl("S2", ERPset) ~ "Binary")) 


nref_gdr <- nref_labels |> filter(Gender_Status == "Gendered") |>
  select(-Gender_Status) |>
  mutate(Referentiality = factor(Referentiality, levels= c("Referential", "Bound variable"))) |>
  mutate(Pronoun = factor(Pronoun, levels = c("Congruent", 
                                              "Incongruent", 
                                              "Neutral")))

nref_ngd <- nref_labels |> filter(Gender_Status == "NonGendered") |>
  select(-Gender_Status) |>
  mutate(Referentiality = factor(Referentiality, levels= c("Referential", "Bound variable"))) |>
  mutate(Pronoun = factor(Pronoun, levels = c("Masculine", 
                                              "Feminine", 
                                              "Neutral"))) 
```

# Test of ANOVA Model with Electrode nested within subject

This model includes Referentiality and Pronoun as fixed effects and  their interaction (Referentiality * Pronoun). It estimates the main effect of Referentiality, the main effect of Pronoun and the Referentiality × Pronoun interaction. It specifies random intercepts and random slopes for both Referentiality and Pronoun by subject (1 + Referentiality + Pronoun | SubjID), thereby accounting  for individual differences in baseline (intercept) as well as individual variability in how Referentiality and Pronoun affect the outcome. It adds random intercepts by electrode (chlabel) nested within subject (1 | SubjID:chlabel) which captures the idea that each electrode may behave differently for each subject (i.e., nested variability across electrode sites within subjects).

To determine whether including random intercepts for electrode site nested within subject improved model fit, we compared a full model including this term to a simplified model without it. 
R code to test the nested electrode random effect across all four models, comparing:
 
- A full model with the nested electrode term: 
	`(1 + Referentiality + TrialType | SubjID) + (1 | SubjID:chlabel)`
	
- A simpler model without it: 
	`(1 + Referentiality + TrialType | SubjID`)

<br>

```{r}
library(afex)
library(lme4)

# Create a function to compare nested vs non-nested models
compare_models <- function(data, label) {
  message("Running model comparisons for: ", label)
  
  # Full model: includes nested electrode intercept
  model_full <- mixed(
    value ~ Referentiality * Pronoun +
      (1 + Referentiality + Pronoun | SubjID) +
      (1 | SubjID:chlabel),
    data = data,
    method = "KR",
    return = "merMod"
  )
  
  # Simpler model: no nested electrode term
  model_simple <- mixed(
    value ~ Referentiality * Pronoun +
      (1 + Referentiality + Pronoun | SubjID),
    data = data,
    method = "KR",
    return = "merMod"
  )
  
  # Likelihood ratio test between full and simplified models
  comp <- anova(model_simple, model_full)
  print(comp)
  
  # Return model comparison object for inspection
  return(comp)
}

# Run comparisons for all datasets
comp_gdr <- compare_models(nref_gdr, "Gendered")
comp_ngd <- compare_models(nref_ngd, "Non-Gendered")
```

## ANOVA Model I Gendered 

```{r}
#Fit ANOVA model
anova_elec_nested_1 <- mixed(
    value ~ Referentiality * Pronoun +
      (1 + Referentiality + Pronoun | SubjID) +
      (1 | SubjID:chlabel),
  data   = nref_gdr,
  method = "KR")
anova_elec_nested_1

# m1 <- anova_elec_nested_1$full_model    # Extract the lmer model
# ranova(m1)    # Run random effects comparison
# drop1(m1)

# Extract effect sizes from your ANOVA model
eta_squared(anova_elec_nested_1, partial = TRUE)

# Compute Marginal(fixed effects only) and Conditional(fixed + random effects) R²
r2(anova_elec_nested_1)
```

### Simple Effects Analyses


```{r}
tt.ref.contrasts_gdr <- c("Referential Congruent - Referential Incongruent",
                      "Referential Congruent - Referential Neutral",
                      "Bound variable Congruent - Bound variable Incongruent",
                      "Bound variable Congruent - Bound variable Neutral")
emmeans_obj_1 <- emmeans(anova_elec_nested_1, pairwise ~ Referentiality * Pronoun, 
                          adjust = "none", pbkrtest.limit = 6480)
tt.ref.means_1 <- as_tibble(emmeans_obj_1$emmeans)
tt.ref.contrasts_df_1 <- as_tibble(subset(emmeans_obj_1$contrasts, contrast %in% tt.ref.contrasts_gdr))

tt.ref.contrasts_df_1 <- tt.ref.contrasts_df_1 |>
  mutate(p.value.adjusted = p.adjust(p.value, method = "bonferroni"))

# Number of subjects
n <- 38
tt.ref.contrasts_df_with_dz_1 <- tt.ref.contrasts_df_1 |>
  rowwise() |>
  mutate(result = list(get_dz_CI(t.ratio, df, n))) |>
  unnest_wider(result)

# Means and Contrasts
tt.ref.means_1
tt.ref.contrasts_df_with_dz_1
```

### Interaction Plot

```{r}
p1 <- tt.ref.means_1 |> 
  ggplot(aes(x = Referentiality , y = emmean, fill = Pronoun, colour = Pronoun)) +
  geom_col(alpha = .4, position = position_dodge(.9)) +
  geom_text(aes(label = round(emmean, digits = 2), vjust = -6), 
            colour = "black", size =3, position = position_dodge(.9)) +
  coord_cartesian(ylim = c(-.75, 2.25)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), 
                width = .075,
                position = position_dodge(.9)) +
  ylab("Mean ERP Amplitude (microvolts)") +
  scale_color_custom() +
  scale_fill_custom() +
  labs(title = "Gendered Antecedent") +
  theme(plot.title = element_text(size = 8, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size= 8)) + 
        scale_x_discrete(labels=c("Referential" = "Referential \n ('Mary...herself/himself/themselves')",
                                  "Bound variable" = "Bound variable \n ('Some woman...herself/himself/themselves')")) 
 p1
```

## ANOVA Model II  Singular NonGendered (NonReferential—Someone…himself/herself; Referential—The runner…himself/herself)

```{r}
#Fit ANOVA model
anova_elec_nested_2 <- mixed(
    value ~ Referentiality * Pronoun +
      (1 + Referentiality + Pronoun | SubjID) +
      (1 | SubjID:chlabel) , 
  data   = nref_ngd,
  method = "KR")
anova_elec_nested_2


m2 <- anova_elec_nested_2$full_model    # Extract the lmer model
ranova(m2)    # Run random effects comparison
drop1(m2)

# Extract effect sizes from your ANOVA model
eta_squared(anova_elec_nested_2, partial = TRUE)

# Compute Marginal(fixed effects only) and Conditional(fixed + random effects) R²
r2(anova_elec_nested_2)
```

### Simple Effects Analyses

```{r}
tt.ref.contrasts_ngd <- c("Referential Masculine - Referential Feminine",
                      "Referential Masculine - Referential Neutral",
                      "Bound variable Masculine - Bound variable Feminine",
                      "Bound variable Masculine - Bound variable Neutral")
emmeans_obj_2 <- emmeans(anova_elec_nested_2, pairwise ~ Referentiality * Pronoun, 
                          adjust = "none", pbkrtest.limit = 6480)
tt.ref.means_2 <- as_tibble(emmeans_obj_2$emmeans)
tt.ref.contrasts_df_2 <- as_tibble(subset(emmeans_obj_2$contrasts, contrast %in% tt.ref.contrasts_ngd))

tt.ref.contrasts_df_2 <- tt.ref.contrasts_df_2 |>
  mutate(p.value.adjusted = p.adjust(p.value, method = "bonferroni"))

# Number of subjects
n <- 38
tt.ref.contrasts_df_with_dz_2 <- tt.ref.contrasts_df_2 |>
  rowwise() |>
  mutate(result = list(get_dz_CI(t.ratio, df, n))) |>
  unnest_wider(result)

# Means and Contrasts
tt.ref.means_2
tt.ref.contrasts_df_with_dz_2
```

### Interaction Plot

```{r}
p2 <- tt.ref.means_2 |> 
  ggplot(aes(x = Referentiality , y = emmean, fill = Pronoun, colour = Pronoun)) +
  geom_col(alpha = .4, position = position_dodge(.9)) +
  geom_text(aes(label = round(emmean, digits = 2), vjust = -6), 
            colour = "black", size =3, position = position_dodge(.9)) +
  coord_cartesian(ylim = c(-.75, 2.25)) +
  geom_errorbar(aes(ymin = emmean - SE, ymax = emmean + SE), 
                width = .075,
                position = position_dodge(.9)) +
  ylab("Mean ERP Amplitude (microvolts)") +
  scale_color_custom() +
  scale_fill_custom() +
  labs(title = "Non-Gendered Antecedent") +
  theme(plot.title = element_text(size = 8, hjust = .5),
        legend.title = element_blank(),
        legend.text = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size= 8)) + 
        scale_x_discrete(labels=c("Referential" = "Referential \n ('The runner...himself/herself/themselves')",
                                  "Bound variable" = "Bound variable \n ('Someone...himself/herself/themselves')")) 
 p2
```


